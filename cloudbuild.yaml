# Cloud Build pipeline for Terraform (plan+apply) with security scanning
# Uses SA impersonation inside the Terraform provider; no JSON keys used.

steps:
- name: gcr.io/google.com/cloudsdktool/cloud-sdk
  id: debug-whoami
  entrypoint: bash
  args:
  - -c
  - |
    set -e
    echo "Active project:"; gcloud config get-value project
    echo "ADC accounts:"; gcloud auth list
    echo "Impersonation target: ${DEPLOY_SA}"
    echo "Try impersonation now:"
    gcloud auth print-access-token --impersonate-service-account="${DEPLOY_SA}" >/dev/null && echo "Impersonation OK" || echo "Impersonation FAILED"

substitutions:
  _ENV_DIR: "envs/dev"
  _TF_STATE_BUCKET: "tfstate-terraform-488518"
  _TF_STATE_PREFIX: "network/dev"

options:
  logging: CLOUD_LOGGING_ONLY

steps:
- name: gcr.io/cloud-builders/gcloud
  id: Show Versions
  entrypoint: bash
  args:
    - -lc
    - |
      cd ${_ENV_DIR}
      gcloud --version
      terraform -version || true

- name: hashicorp/terraform:1.6.6
  id: fmt-validate
  entrypoint: sh
  args:
    - -c
    - |
      cd ${_ENV_DIR}
      terraform fmt -check
      terraform init -input=false         -backend-config="bucket=${_TF_STATE_BUCKET}"         -backend-config="prefix=${_TF_STATE_PREFIX}"
      terraform validate

- name: gcr.io/cloud-builders/gcloud
  id: tfsec
  entrypoint: bash
  args:
    - -lc
    - |
      curl -sSL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
      tfsec --soft-fail ${_ENV_DIR}

- name: hashicorp/terraform:1.6.6
  id: plan
  entrypoint: sh
  args:
    - -c
    - |
      cd ${_ENV_DIR}
      terraform plan -input=false -out=tfplan

- name: hashicorp/terraform:1.6.6
  id: apply
  entrypoint: sh
  args:
    - -c
    - |
      cd ${_ENV_DIR}
      terraform apply -input=false -auto-approve tfplan
